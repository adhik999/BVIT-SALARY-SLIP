<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - BVIT SALARY SLIP</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="icon" type="image/x-icon" href="../public/favicon.ico" />
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fteacherpay1871back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.7"></script>
    <!-- Firebase Integration -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- Excel Processing Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../config/firebase-config.js"></script>
    <script src="../js/firebase-db.js"></script>
    <script src="../js/paysheet-importer.js"></script>
</head>
<body class="min-h-screen bg-background">
    <!-- Fixed Header -->
    <header class="fixed top-0 left-0 right-0 z-fixed bg-surface shadow-elevation-1 border-b border-secondary-200">
        <div class="flex items-center justify-between px-6 py-4">
            <!-- Logo and Institution Branding -->
            <div class="flex items-center space-x-4">
                <button id="sidebar-toggle" class="lg:hidden p-2 rounded-md hover:bg-secondary-100 transition-colors duration-200">
                    <svg class="w-5 h-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center shadow-elevation-1">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-text-primary">BVIT SALARY SLIP</h1>
                        <p class="text-xs text-text-secondary font-caption">Admin Portal</p>
                    </div>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center space-x-4">
                <!-- Notifications -->
                <button class="relative p-2 rounded-md hover:bg-secondary-100 transition-colors duration-200">
                    <svg class="w-5 h-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM10.07 2.82l3.12 3.12M7.05 5.84l3.12 3.12M4.03 8.86l3.12 3.12"/>
                    </svg>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-error-500 rounded-full"></span>
                </button>

                <!-- Admin Profile Dropdown -->
                <div class="relative" id="profile-dropdown">
                    <button id="profile-button" class="flex items-center space-x-3 p-2 rounded-md hover:bg-secondary-100 transition-colors duration-200">
                        <img src="https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" alt="Admin Profile" class="w-8 h-8 rounded-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;" />
                        <div class="hidden md:block text-left">
                            <p class="text-sm font-medium text-text-primary" id="admin-name">Administrator</p>
                            <p class="text-xs text-text-secondary font-caption">System Administrator</p>
                        </div>
                        <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-surface rounded-md shadow-elevation-2 border border-secondary-200 z-dropdown">
                        <div class="py-1">
                            <a href="javascript:void(0)" class="flex items-center px-4 py-2 text-sm text-text-secondary hover:bg-secondary-50 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Profile Settings
                            </a>
                            <a href="javascript:void(0)" class="flex items-center px-4 py-2 text-sm text-text-secondary hover:bg-secondary-50 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                System Settings
                            </a>
                            <div class="border-t border-secondary-200 my-1"></div>
                            <button id="logout-btn" class="flex items-center w-full px-4 py-2 text-sm text-error-600 hover:bg-error-50 transition-colors duration-200">
                                <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-16 bottom-0 w-64 bg-surface border-r border-secondary-200 shadow-elevation-1 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-sticky">
        <nav class="p-4 space-y-2">
            <!-- Dashboard -->
            <a href="admin_dashboard.html" class="flex items-center space-x-3 px-3 py-2 rounded-md bg-primary-50 text-primary-700 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"/>
                </svg>
                <span>Dashboard</span>
            </a>


            <!-- Payroll Management -->
            <div class="space-y-1">
                <button class="flex items-center justify-between w-full px-3 py-2 rounded-md text-text-secondary hover:bg-secondary-50 hover:text-text-primary transition-colors duration-200">
                    <div class="flex items-center space-x-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                        </svg>
                        <span>Payroll</span>
                    </div>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div class="ml-8 space-y-1">
                    <button id="sidebar-import-btn" class="block w-full text-left px-3 py-1 text-sm text-text-secondary hover:text-text-primary transition-colors duration-200">Import Paysheet</button>
                </div>
            </div>

        </nav>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-64 pt-16 min-h-screen">
        <div class="p-6">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-fluid-2xl font-semibold text-text-primary mb-2">Dashboard Overview</h1>
                <p class="text-text-secondary font-caption">Welcome back. Here's what's happening with your payroll system today.</p>
            </div>

            <!-- Grid Layout -->
            <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                <!-- Left Section (8 columns) -->
                <div class="xl:col-span-8 space-y-6">
                    <!-- Key Metrics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Total Teachers -->
                        <div class="glass-card p-6 hover-lift">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-text-secondary font-caption">Total Teachers</p>
                                    <p class="text-fluid-2xl font-semibold text-text-primary font-data" id="total-teachers">0</p>
                                </div>
                                <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center">
                                <span class="text-sm text-text-secondary font-caption">No data available</span>
                            </div>
                        </div>

                        <!-- Current Month Processing -->
                        <div class="glass-card p-6 hover-lift">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-text-secondary font-caption">August 2025</p>
                                    <p class="text-fluid-2xl font-semibold text-text-primary font-data">Processed</p>
                                </div>
                                <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center">
                                <span class="text-sm text-text-secondary font-caption" id="processed-slips">0/0 slips generated</span>
                            </div>
                        </div>

                        <!-- Recent Uploads -->
                        <div class="glass-card p-6 hover-lift">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-text-secondary font-caption">Recent Uploads</p>
                                    <p class="text-fluid-2xl font-semibold text-text-primary font-data" id="recent-uploads">0</p>
                                </div>
                                <div class="w-12 h-12 bg-accent-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-accent-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center">
                                <span class="text-sm text-text-secondary font-caption" id="last-upload">No recent uploads</span>
                            </div>
                        </div>

                        <!-- System Alerts -->
                        <div class="glass-card p-6 hover-lift">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-text-secondary font-caption">System Alerts</p>
                                    <p class="text-fluid-2xl font-semibold text-text-primary font-data" id="system-alerts">0</p>
                                </div>
                                <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-warning-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center">
                                <span class="text-sm text-text-secondary font-caption" id="alerts-status">No alerts</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions Panel -->
                    <div class="glass-card p-6">
                        <h2 class="text-fluid-lg font-semibold text-text-primary mb-4">Quick Actions</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="import-paysheet-btn" class="btn-primary p-4 text-left hover-lift cursor-pointer" style="pointer-events: auto;">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-white">Import Paysheet</h3>
                                        <p class="text-sm text-blue-100 font-caption">Upload monthly data</p>
                                    </div>
                                </div>
                            </button>

                            <button onclick="showAddTeacherModal()" class="btn-accent p-4 text-left hover-lift">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-white">Add Teacher</h3>
                                        <p class="text-sm text-emerald-100 font-caption">Register new staff</p>
                                    </div>
                                </div>
                            </button>

                            <button class="btn-secondary p-4 text-left hover-lift">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-secondary-200 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-secondary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-secondary-700">Generate Reports</h3>
                                        <p class="text-sm text-secondary-600 font-caption">Monthly analytics</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Teacher Records Table -->
                    <div class="glass-card p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                            <h2 class="text-fluid-lg font-semibold text-text-primary mb-4 sm:mb-0">Teacher Records</h2>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                                <!-- Search -->
                                <div class="relative">
                                    <input type="text" id="teacher-search" placeholder="Search teachers..." class="form-input pl-10 w-full sm:w-64" />
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-secondary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Filter -->
                                <select class="form-input">
                                    <option>All Departments</option>
                                    <option>Mathematics</option>
                                    <option>Science</option>
                                    <option>English</option>
                                    <option>History</option>
                                </select>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="rounded border-secondary-300 text-primary focus:ring-primary-500" />
                                        </th>
                                        <th>Teacher ID</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Status</th>
                                        <th>Last Payslip</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="teacher-table-body">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="flex items-center justify-between mt-6">
                            <div class="text-sm text-text-secondary font-caption">
                                Showing 0 to 0 of 0 results
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="px-3 py-1 text-sm border border-secondary-200 rounded-md hover:bg-secondary-50 transition-colors duration-200">Previous</button>
                                <button class="px-3 py-1 text-sm bg-primary text-white rounded-md">1</button>
                                <button class="px-3 py-1 text-sm border border-secondary-200 rounded-md hover:bg-secondary-50 transition-colors duration-200">2</button>
                                <button class="px-3 py-1 text-sm border border-secondary-200 rounded-md hover:bg-secondary-50 transition-colors duration-200">3</button>
                                <button class="px-3 py-1 text-sm border border-secondary-200 rounded-md hover:bg-secondary-50 transition-colors duration-200">Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section (4 columns) -->
                <div class="xl:col-span-4 space-y-6">

                    <!-- Payslip Requests Widget -->
                    <div class="glass-card p-6">
                        <h2 class="text-fluid-lg font-semibold text-text-primary mb-4">Payslip Requests</h2>
                        <div id="payslip-requests" class="space-y-3">
                            <!-- Dynamic payslip requests will be loaded here -->
                        </div>
                    </div>

                    <!-- Pending Teacher Approvals Widget -->
                    <div class="glass-card p-6">
                        <h2 class="text-fluid-lg font-semibold text-text-primary mb-4">Pending Teacher Approvals</h2>
                        <div id="pending-teacher-approvals" class="space-y-3">
                            <!-- Dynamic pending teacher approvals will be loaded here -->
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </main>

    <!-- Import Paysheet Modal -->
    <div id="import-modal" class="hidden fixed inset-0 z-modal bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="glass-card max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-fluid-lg font-semibold text-text-primary">Import Paysheet</h3>
                <button id="close-modal" class="text-text-secondary hover:text-text-primary transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="form-label">Select Month</label>
                    <select id="import-month" class="form-input">
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August" selected>August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
                
                <div>
                    <label class="form-label">Select Year</label>
                    <select id="import-year" class="form-input">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                
                <div>
                    <label class="form-label">Upload File</label>
                    <div id="drop-zone" class="border-2 border-dashed border-secondary-300 rounded-md p-6 text-center cursor-pointer hover:border-primary-300 transition-colors">
                        <svg class="w-8 h-8 text-secondary-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-sm text-text-secondary font-caption">Drop your CSV or Excel file here or click to browse</p>
                        <input id="file-input" type="file" class="hidden" accept=".csv,.xlsx,.xls" />
                    </div>
                    <div class="mt-2 text-xs text-text-secondary">
                        <button id="download-sample" class="text-primary hover:underline">Download sample CSV format</button>
                    </div>
                </div>
                
                <!-- Progress indicator -->
                <div id="import-progress" class="hidden">
                    <div class="flex items-center space-x-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                        <span class="text-sm text-text-secondary">Processing paysheet...</span>
                    </div>
                </div>
                
                <!-- Result message -->
                <div id="import-result" class="hidden p-3 rounded-md">
                    <p id="import-result-message" class="text-sm font-medium"></p>
                </div>
                
                <div class="flex space-x-3">
                    <button id="upload-process-btn" class="btn-primary flex-1" disabled>Upload & Process</button>
                    <button id="cancel-modal" class="btn-secondary flex-1">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Teacher Modal -->
    <div id="add-teacher-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Add New Teacher</h3>
                        <button onclick="closeAddTeacherModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="add-teacher-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Designation</label>
                            <input type="text" name="designation" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <select name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Select Department</option>
                                <option value="COMPUTER">COMPUTER</option>
                                <option value="MECHANICAL">MECHANICAL</option>
                                <option value="CIVIL">CIVIL</option>
                                <option value="ELECTRICAL">ELECTRICAL</option>
                                <option value="ELECTRONICS">ELECTRONICS</option>
                                <option value="OFFICE">OFFICE</option>
                                <option value="LIBRARY">LIBRARY</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Initial Password</label>
                            <input type="password" name="password" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <p class="text-xs text-gray-500 mt-1">Teacher can change this password after first login</p>
                        </div>
                    </form>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button onclick="addNewTeacher()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Add Teacher
                    </button>
                    <button onclick="closeAddTeacherModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        });

        // Profile dropdown functionality
        document.getElementById('profile-button').addEventListener('click', function() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profile-dropdown');
            const menu = document.getElementById('profile-menu');
            
            if (!dropdown.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // File upload functionality
        let selectedFile = null;
        
        // Handle file selection
        function handleFileSelection(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert('Please select a CSV or Excel file (.csv, .xlsx, .xls).');
                return;
            }
            
            selectedFile = file;
            const uploadButton = document.getElementById('upload-process-btn');
            const dropZone = document.getElementById('drop-zone');
            
            if (!dropZone) {
                console.error('Drop zone element not found');
                return;
            }
            
            // Update UI to show file selected
            const fileInfo = dropZone.querySelector('.file-info');
            if (fileInfo) {
                fileInfo.remove();
            }
            
            const fileInfoDiv = document.createElement('div');
            fileInfoDiv.className = 'file-info mt-2 p-2 bg-primary-50 rounded text-sm';
            fileInfoDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-primary-700">ðŸ“„ ${file.name}</span>
                    <span class="text-xs text-primary-600">${(file.size / 1024).toFixed(1)} KB</span>
                </div>
            `;
            dropZone.appendChild(fileInfoDiv);
            
            // Enable upload button
            if (uploadButton) {
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-50');
            }
        }
        
        // Process paysheet file
        async function processPaysheetFile() {
            if (!selectedFile) return;
            
            const month = document.getElementById('import-month').value;
            const year = document.getElementById('import-year').value;
            const progressDiv = document.getElementById('import-progress');
            const resultDiv = document.getElementById('import-result');
            const resultMessage = document.getElementById('import-result-message');
            
            try {
                // Show progress
                progressDiv.classList.remove('hidden');
                resultDiv.classList.add('hidden');
                
                // Create importer and process file
                const importer = new PaysheetImporter();
                const result = await importer.importPaysheetFile(selectedFile, month, year);
                
                // Hide progress
                progressDiv.classList.add('hidden');
                
                if (result.success) {
                    // Show success result
                    resultDiv.classList.remove('hidden');
                    resultDiv.className = 'p-3 rounded-md bg-success-50 border border-success-200';
                    resultMessage.textContent = result.message;
                    resultMessage.className = 'font-medium text-success-700';
                    
                    // Auto-close modal after 3 seconds
                    setTimeout(() => {
                        document.getElementById('import-modal').classList.add('hidden');
                        // Refresh the page to show updated data
                        window.location.reload();
                    }, 3000);
                } else {
                    // Show error result
                    resultDiv.classList.remove('hidden');
                    resultDiv.className = 'p-3 rounded-md bg-error-50 border border-error-200';
                    resultMessage.textContent = result.message;
                    resultMessage.className = 'font-medium text-error-700';
                }
            } catch (error) {
                console.error('Import error:', error);
                
                // Hide progress and show error
                progressDiv.classList.add('hidden');
                resultDiv.classList.remove('hidden');
                resultDiv.className = 'p-3 rounded-md bg-error-50 border border-error-200';
                resultMessage.textContent = 'Error importing paysheet: ' + error.message;
                resultMessage.className = 'font-medium text-error-700';
            }
        }

        // Import paysheet modal functionality
        function showImportModal() {
            document.getElementById('import-modal').classList.remove('hidden');
            // Reset form
            selectedFile = null;
            const fileInput = document.getElementById('file-input');
            const uploadButton = document.getElementById('upload-process-btn');
            
            if (fileInput) {
                fileInput.value = '';
            }
            if (uploadButton) {
                uploadButton.disabled = true;
                uploadButton.classList.add('opacity-50');
            }
            
            // Reset progress and result displays
            document.getElementById('import-progress').classList.add('hidden');
            document.getElementById('import-result').classList.add('hidden');
        }

        // Initialize modal functionality after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get references to modal elements
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');
            const uploadButton = document.getElementById('upload-process-btn');
            const downloadSampleBtn = document.getElementById('download-sample');

            // Set initial upload button state
            if (uploadButton) {
                uploadButton.disabled = true;
                uploadButton.classList.add('opacity-50');
            }

            // File input and drop zone functionality
            if (fileInput && dropZone) {
                // Click to browse
                dropZone.addEventListener('click', () => fileInput.click());

                // File selection
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileSelection(file);
                    }
                });

                // Drag and drop
                dropZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropZone.classList.add('border-primary-400', 'bg-primary-50');
                });

                dropZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    dropZone.classList.remove('border-primary-400', 'bg-primary-50');
                });

                dropZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropZone.classList.remove('border-primary-400', 'bg-primary-50');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelection(files[0]);
                    }
                });
            }

            // Download sample CSV
            if (downloadSampleBtn) {
                downloadSampleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const importer = new PaysheetImporter();
                    importer.downloadSampleCSV();
                });
            }

            // Upload and process button
            if (uploadButton) {
                uploadButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (selectedFile) {
                        processPaysheetFile();
                    }
                });
            }

            // Add event listeners for import buttons
            const importBtn = document.getElementById('import-paysheet-btn');
            if (importBtn) {
                importBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ðŸš€ Import Paysheet button clicked!');
                    showImportModal();
                });
                console.log('âœ… Import button event listener attached');
            }

            // Fixed: Add proper event listener for sidebar Import Paysheet link
            const sidebarImportLink = document.getElementById('sidebar-import-btn');
            if (sidebarImportLink) {
                sidebarImportLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('ðŸš€ Sidebar Import Paysheet clicked!');
                    showImportModal();
                });
            }

            // Modal close functionality
            document.getElementById('close-modal').addEventListener('click', function() {
                document.getElementById('import-modal').classList.add('hidden');
            });

            document.getElementById('cancel-modal').addEventListener('click', function() {
                document.getElementById('import-modal').classList.add('hidden');
            });

            // Close modal when clicking outside
            document.getElementById('import-modal').addEventListener('click', function(event) {
                if (event.target === this) {
                    this.classList.add('hidden');
                }
            });

            // Remove duplicate file upload functionality (already handled above)

            // Upload button functionality
            if (uploadButton) {
                uploadButton.addEventListener('click', async function() {
                    if (!selectedFile) {
                        showNotification('Please select a file first.', 'error');
                        return;
                    }

                    const selectedMonth = document.getElementById('import-month').value;
                    const selectedYear = document.getElementById('import-year').value;
                    
                    // Show loading state
                    this.innerHTML = `
                        <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    `;
                    this.disabled = true;

                    try {
                        // Simulate file processing with FormData
                        const formData = new FormData();
                        formData.append('paysheet', selectedFile);
                        formData.append('month', selectedMonth);
                        
                        // Use PaysheetImporter for proper file processing
                        const importer = new PaysheetImporter();
                        const result = await importer.importPaysheetFile(selectedFile, selectedMonth, selectedYear);
                        
                        // Simulate API call delay
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Show success message
                        if (result.success) {
                            showNotification(result.message, 'success');
                        } else {
                            throw new Error(result.message);
                        }
                        
                        // Close modal
                        document.getElementById('import-modal').classList.add('hidden');
                        
                        // Refresh the page to show updated data
                        window.location.reload();
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        showNotification('Failed to import paysheet. Please check your file format and try again.', 'error');
                    } finally {
                        // Reset button
                        this.innerHTML = 'Upload & Process';
                        this.disabled = false;
                    }
                });
            }
        });

        // Duplicate function code removed

        // File reading utility
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = function() {
                    reject(new Error('Failed to read file'));
                };
                reader.readAsText(file);
            });
        }

        // Removed duplicate processPaysheetData function - using PaysheetImporter class instead

        // Update dashboard after successful import
        function updateDashboardAfterImport(data) {
            // Update recent activity
            const activityFeed = document.querySelector('.space-y-4');
            if (activityFeed) {
                const newActivity = document.createElement('div');
                newActivity.className = 'flex items-start space-x-3';
                newActivity.innerHTML = `
                    <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-text-primary">${data.month} paysheet uploaded successfully</p>
                        <p class="text-xs text-text-secondary font-caption">Just now</p>
                    </div>
                `;
                activityFeed.insertBefore(newActivity, activityFeed.firstChild);
            }
            
            // Update recent uploads count
            const recentUploadsCards = document.querySelectorAll('.glass-card');
            recentUploadsCards.forEach(card => {
                const titleElement = card.querySelector('p.font-caption');
                if (titleElement && titleElement.textContent.includes('Recent Uploads')) {
                    const countElement = card.querySelector('p.font-data');
                    if (countElement) {
                        const currentCount = parseInt(countElement.textContent) || 0;
                        countElement.textContent = currentCount + 1;
                    }
                }
            });
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification fixed top-20 right-4 z-50 p-4 rounded-md shadow-lg max-w-sm transition-all duration-300`;
            
            const bgColor = type === 'success' ? 'bg-success-500' : 
                           type === 'error' ? 'bg-error-500' : 'bg-primary';
            
            notification.classList.add(bgColor);
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-1">
                        <p class="text-white text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 transition-colors duration-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to sign out?')) {
                sessionStorage.clear();
                localStorage.removeItem('paysheetData'); // Clear uploaded data on logout
                window.location.href = 'admin_login.html';
            }
        });

        // Search functionality
        document.getElementById('teacher-search').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('#teacher-table-body tr');
            
            tableRows.forEach(row => {
                const teacherName = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                const teacherId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                
                if (teacherName.includes(searchTerm) || teacherId.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Load teachers and paysheet data from Firebase and update UI
        async function loadTeachers() {
            try {
                console.log('ðŸ” Loading teachers from Firebase...');
                
                // Use direct Firebase reference for consistency
                const teachersRef = firebase.database().ref('teachers');
                const snapshot = await teachersRef.once('value');
                const teachersData = snapshot.val();
                
                console.log('ðŸ“Š Raw Firebase teachers data:', teachersData);
                
                let teachers = [];
                
                if (teachersData) {
                    teachers = Object.keys(teachersData).map(key => ({
                        id: key,
                        ...teachersData[key]
                    }));
                    console.log('ðŸ“Š Loaded from Firebase:', teachers.length, 'teachers');
                } else {
                    console.log('âš ï¸ No teachers found in Firebase, checking localStorage...');
                }
                
                // Always check localStorage for additional pending teachers
                const storedTeachers = JSON.parse(localStorage.getItem('teachers')) || [];
                console.log('ðŸ“Š localStorage teachers:', storedTeachers.length);
                
                // Merge localStorage teachers that are not in Firebase
                storedTeachers.forEach(localTeacher => {
                    const existsInFirebase = teachers.some(fbTeacher => fbTeacher.id === localTeacher.id);
                    if (!existsInFirebase) {
                        console.log('âž• Adding localStorage teacher to display:', localTeacher.name, localTeacher.status);
                        teachers.push(localTeacher);
                    }
                });
                
                console.log('ðŸ“Š Total merged teachers:', teachers.length);
                
                // Get paysheet data from Firebase - with fallback
                let paysheetData = {};
                try {
                    const paysheetRef = firebase.database().ref('paysheetData');
                    const paysheetSnapshot = await paysheetRef.once('value');
                    paysheetData = paysheetSnapshot.val() || {};
                    console.log('âœ… PaysheetData loaded successfully:', Object.keys(paysheetData).length, 'months');
                } catch (paysheetError) {
                    console.warn('âš ï¸ Could not load paysheetData, using empty object:', paysheetError.message);
                    paysheetData = {};
                }
                
                const pendingTeachers = teachers.filter(t => t.status === 'Pending Approval');
                console.log('â³ Pending teachers found:', pendingTeachers.length);
                
                // Log each teacher for debugging
                teachers.forEach(teacher => {
                    console.log(`ðŸ‘¤ TEACHER: ${teacher.name} (${teacher.id}) - Status: ${teacher.status}`);
                });
                
                // Log pending teachers specifically
                pendingTeachers.forEach(teacher => {
                    console.log(`â³ PENDING: ${teacher.name} (${teacher.id}) - Registered: ${teacher.registrationDate}`);
                });
                
                updateTeacherTable(teachers);
                updateDashboardMetrics(teachers, paysheetData);
                updatePendingApprovals(teachers);
                
            } catch (error) {
                console.error('âŒ Error loading teachers:', error);
                // Final fallback to localStorage
                const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
                console.log('ðŸ“Š Final fallback: Loading teachers from localStorage:', teachers.length, 'total');
                updateTeacherTable(teachers);
                updateDashboardMetrics(teachers, {});
                updatePendingApprovals(teachers);
            }
        }

        // Update teacher table
        function updateTeacherTable(teachers) {
            const tbody = document.getElementById('teacher-table-body');
            if (!tbody) return;

            if (teachers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-12">
                            <div class="flex flex-col items-center justify-center space-y-3">
                                <svg class="w-16 h-16 text-secondary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                                </svg>
                                <div>
                                    <h3 class="text-lg font-medium text-text-primary">No Teachers Found</h3>
                                    <p class="text-text-secondary font-caption">Start by adding your first teacher to the system.</p>
                                </div>
                                <button onclick="window.location.href='teacher_registration_management.html'" class="btn-primary px-6 py-2 mt-4">
                                    Add First Teacher
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = teachers.map(teacher => {
                const statusClass = getStatusClass(teacher.status);
                const lastPayslip = 'Not Generated'; // Placeholder
                
                return `
                    <tr>
                        <td><input type="checkbox" class="rounded border-secondary-300 text-primary focus:ring-primary-500" data-id="${teacher.id}"></td>
                        <td class="font-data">${teacher.id}</td>
                        <td>${teacher.name}</td>
                        <td>${teacher.department}</td>
                        <td><span class="${statusClass}">${teacher.status}</span></td>
                        <td class="text-sm text-text-secondary">${lastPayslip}</td>
                        <td>
                            <div class="flex items-center space-x-2">
                                ${teacher.status === 'Pending Approval' ? `
                                    <button onclick="approveTeacher('${teacher.id}')" class="p-1 rounded hover:bg-success-50 transition-colors duration-200" title="Approve">
                                        <svg class="w-4 h-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </button>
                                    <button onclick="rejectTeacher('${teacher.id}')" class="p-1 rounded hover:bg-error-50 transition-colors duration-200" title="Reject">
                                        <svg class="w-4 h-4 text-error-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                ` : `
                                    <button onclick="viewTeacher('${teacher.id}')" class="p-1 rounded hover:bg-secondary-100 transition-colors duration-200" title="View Details">
                                        <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </button>
                                `}
                                <button onclick="editTeacher('${teacher.id}')" class="p-1 rounded hover:bg-secondary-100 transition-colors duration-200" title="Edit">
                                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="deleteTeacher('${teacher.id}')" class="p-1 rounded hover:bg-error-50 transition-colors duration-200" title="Delete Teacher">
                                    <svg class="w-4 h-4 text-error-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status class for styling
        function getStatusClass(status) {
            switch (status) {
                case 'Active':
                    return 'status-success';
                case 'Pending Approval':
                    return 'status-warning';
                case 'Inactive':
                case 'Rejected':
                    return 'status-error';
                default:
                    return 'status-secondary';
            }
        }

        // Update dashboard metrics with Firebase data
        function updateDashboardMetrics(teachers, paysheetData = {}) {
            const totalTeachers = teachers.length;
            const activeTeachers = teachers.filter(t => t.status === 'Active').length;
            const pendingTeachers = teachers.filter(t => t.status === 'Pending Approval').length;

            // Update total teachers count
            document.getElementById('total-teachers').textContent = totalTeachers;
            
            // Calculate paysheet statistics
            const currentMonth = new Date().toLocaleString('default', { month: 'long' });
            const currentYear = new Date().getFullYear();
            const monthKey = `${currentMonth.toLowerCase()}_${currentYear}`;
            
            let processedSlips = 0;
            let totalUploads = Object.keys(paysheetData).length;
            let lastUploadDate = 'No recent uploads';
            
            // Count processed slips for current month
            if (paysheetData[monthKey] && paysheetData[monthKey].records) {
                processedSlips = paysheetData[monthKey].records.length;
            }
            
            // Find most recent upload
            if (totalUploads > 0) {
                const sortedMonths = Object.keys(paysheetData).sort((a, b) => {
                    const dateA = paysheetData[a].uploadDate || '1970-01-01';
                    const dateB = paysheetData[b].uploadDate || '1970-01-01';
                    return new Date(dateB) - new Date(dateA);
                });
                
                if (sortedMonths.length > 0 && paysheetData[sortedMonths[0]].uploadDate) {
                    const lastUpload = new Date(paysheetData[sortedMonths[0]].uploadDate);
                    lastUploadDate = lastUpload.toLocaleDateString();
                }
            }
            
            // Update metrics cards
            const metricsCards = document.querySelectorAll('.glass-card');
            metricsCards.forEach(card => {
                const titleElement = card.querySelector('p.font-caption');
                if (titleElement) {
                    if (titleElement.textContent.includes('Total Teachers')) {
                        const statusElement = card.querySelector('.mt-4 span');
                        if (statusElement) {
                            statusElement.textContent = `${activeTeachers} active, ${pendingTeachers} pending approval`;
                        }
                    } else if (titleElement.textContent.includes('August 2025')) {
                        // Update current month processing status
                        const statusElement = card.querySelector('.mt-4 span');
                        if (statusElement) {
                            statusElement.textContent = `${processedSlips}/${totalTeachers} slips generated`;
                        }
                    } else if (titleElement.textContent.includes('Recent Uploads')) {
                        const countElement = card.querySelector('p.font-data');
                        const statusElement = card.querySelector('.mt-4 span');
                        if (countElement) {
                            countElement.textContent = totalUploads;
                        }
                        if (statusElement) {
                            statusElement.textContent = lastUploadDate;
                        }
                    } else if (titleElement.textContent.includes('System Alerts')) {
                        const statusElement = card.querySelector('.mt-4 span');
                        if (statusElement) {
                            // Check for potential alerts
                            let alertCount = 0;
                            let alertStatus = 'No alerts';
                            
                            if (pendingTeachers > 0) {
                                alertCount++;
                                alertStatus = `${pendingTeachers} pending approvals`;
                            }
                            
                            const countElement = card.querySelector('p.font-data');
                            if (countElement) {
                                countElement.textContent = alertCount;
                            }
                            statusElement.textContent = alertStatus;
                        }
                    }
                }
            });
            
            console.log(`ðŸ“Š Dashboard metrics updated: ${totalTeachers} teachers, ${processedSlips} slips, ${totalUploads} uploads`);
        }

        // Update pending approvals widget
        function updatePendingApprovals(teachers) {
            console.log('ðŸ” updatePendingApprovals called with teachers:', teachers.length);
            
            const pendingTeachers = teachers.filter(t => t.status === 'Pending Approval');
            console.log('â³ Filtered pending teachers:', pendingTeachers.length);
            
            // Log each pending teacher for debugging
            pendingTeachers.forEach(teacher => {
                console.log(`â³ PENDING TEACHER: ${teacher.name} (${teacher.id}) - Status: ${teacher.status}`);
            });
            
            const pendingContainer = document.getElementById('pending-teacher-approvals');
            
            if (!pendingContainer) {
                console.error('âŒ Pending container not found!');
                return;
            }

            if (pendingTeachers.length === 0) {
                console.log('ðŸ“ No pending teachers, showing empty state');
                pendingContainer.innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-12 h-12 text-secondary-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-text-secondary font-caption">No pending approvals</p>
                    </div>
                `;
                return;
            }
            
            console.log('âœ… Rendering', pendingTeachers.length, 'pending teachers');

            pendingContainer.innerHTML = pendingTeachers.map(teacher => {
                const registrationDate = new Date(teacher.registrationDate).toLocaleDateString('en-GB');
                return `
                    <div class="flex items-center justify-between p-3 bg-warning-50 rounded-md border border-warning-200">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-warning-500 rounded-full"></div>
                            <div>
                                <p class="text-sm font-medium text-text-primary">${teacher.name} (${teacher.id})</p>
                                <p class="text-xs text-text-secondary font-caption">Registered: ${registrationDate}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="approveTeacher('${teacher.id}')" class="text-success-600 hover:text-success-700 transition-colors duration-200" title="Approve">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                            <button onclick="rejectTeacher('${teacher.id}')" class="text-error-600 hover:text-error-700 transition-colors duration-200" title="Reject">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Approve teacher
        async function approveTeacher(teacherId) {
            if (confirm('Are you sure you want to approve this teacher?')) {
                try {
                    // Get teacher data from Firebase
                    const teachersRef = firebase.database().ref('teachers');
                    const snapshot = await teachersRef.child(teacherId).once('value');
                    const teacher = snapshot.val();
                    
                    if (!teacher) {
                        showNotification('Teacher not found. Please refresh and try again.', 'error');
                        return;
                    }
                    
                    // Update teacher status in Firebase
                    await teachersRef.child(teacherId).update({
                        status: 'Active',
                        approvedBy: 'Admin',
                        approvalDate: new Date().toISOString()
                    });
                    
                    // Also update localStorage for backward compatibility
                    const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
                    const teacherIndex = teachers.findIndex(t => t.id === teacherId);
                    if (teacherIndex !== -1) {
                        teachers[teacherIndex].status = 'Active';
                        teachers[teacherIndex].approvedBy = 'Admin';
                        teachers[teacherIndex].approvalDate = new Date().toISOString();
                        localStorage.setItem('teachers', JSON.stringify(teachers));
                    }
                    
                    console.log('Teacher approved and saved to Firebase:', teacher.name);
                    showNotification(`Teacher ${teacher.name} has been approved successfully!`, 'success');
                    
                } catch (error) {
                    console.error('Error approving teacher:', error);
                    showNotification('Error saving teacher approval. Please try again.', 'error');
                }
            }
        }

        // Reject teacher
        async function rejectTeacher(teacherId) {
            if (confirm('Are you sure you want to reject this teacher registration?')) {
                try {
                    // Get teacher data from Firebase
                    const teachersRef = firebase.database().ref('teachers');
                    const snapshot = await teachersRef.child(teacherId).once('value');
                    const teacher = snapshot.val();
                    
                    if (!teacher) {
                        showNotification('Teacher not found. Please refresh and try again.', 'error');
                        return;
                    }
                    
                    // Update teacher status in Firebase
                    await teachersRef.child(teacherId).update({
                        status: 'Rejected',
                        approvedBy: 'Admin',
                        approvalDate: new Date().toISOString()
                    });
                    
                    // Also update localStorage for backward compatibility
                    const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
                    const teacherIndex = teachers.findIndex(t => t.id === teacherId);
                    if (teacherIndex !== -1) {
                        teachers[teacherIndex].status = 'Rejected';
                        teachers[teacherIndex].approvedBy = 'Admin';
                        teachers[teacherIndex].approvalDate = new Date().toISOString();
                        localStorage.setItem('teachers', JSON.stringify(teachers));
                    }
                    
                    console.log('Teacher rejected and saved to Firebase:', teacher.name);
                    showNotification(`Teacher ${teacher.name} registration has been rejected.`, 'error');
                    
                } catch (error) {
                    console.error('Error rejecting teacher:', error);
                    showNotification('Error rejecting teacher. Please try again.', 'error');
                }
            }
        }

        // View teacher details
        function viewTeacher(teacherId) {
            window.location.href = `teacher_registration_management.html?view=${teacherId}`;
        }

        // Edit teacher
        function editTeacher(teacherId) {
            window.location.href = `teacher_registration_management.html?edit=${teacherId}`;
        }

        // Debug function to check localStorage data
        function debugTeachersData() {
            const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
            console.log('ðŸ” DEBUG - Teachers in localStorage:', teachers);
            console.log('ðŸ” DEBUG - Pending teachers:', teachers.filter(t => t.status === 'Pending Approval'));
            console.log('ðŸ” DEBUG - All localStorage keys:', Object.keys(localStorage));
            
            // Check if there are any teachers with different status values
            const allStatuses = [...new Set(teachers.map(t => t.status))];
            console.log('ðŸ” DEBUG - All status values found:', allStatuses);
            
            return teachers;
        }

        // Check authentication on page load
        window.addEventListener('load', async function() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'admin_login.html';
            } else {
                // Set admin name from session storage
                const adminEmail = sessionStorage.getItem('adminEmail');
                const adminNameElement = document.getElementById('admin-name');
                
                if (adminEmail && adminNameElement) {
                    // Extract name from email or use predefined names
                    let adminName = 'Administrator';
                    if (adminEmail === 'admin@school.edu') {
                        adminName = 'School Admin';
                    } else if (adminEmail === 'principal@college.edu') {
                        adminName = 'Principal';
                    } else if (adminEmail === 'hr@university.edu') {
                        adminName = 'HR Manager';
                    } else {
                        // Extract name from email (before @)
                        adminName = adminEmail.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                    adminNameElement.textContent = adminName;
                }
                
                // Debug localStorage data
                debugTeachersData();
                
                // Initial load with Firebase real-time listeners
                await loadTeachers();
                
                // Set up real-time listeners for live updates
                setupFirebaseListeners();
            }
        });

        // Reports and Settings sections removed - no toggle needed

        // Reports and Settings functions removed - no longer needed

        // Delete teacher function
        function deleteTeacher(teacherId) {
            const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
            const teacher = teachers.find(t => t.id === teacherId);
            
            if (!teacher) {
                showNotification('Teacher not found!', 'error');
                return;
            }

            // Show confirmation dialog with teacher details
            const confirmMessage = `Are you sure you want to DELETE this teacher?\n\nðŸ‘¤ Name: ${teacher.name}\nðŸ†” ID: ${teacher.id}\nðŸ“š Department: ${teacher.department}\nðŸ“Š Status: ${teacher.status}\n\nâš ï¸ WARNING: This action cannot be undone!\nAll teacher data will be permanently removed from the system.`;
            
            if (confirm(confirmMessage)) {
                try {
                    // Remove teacher from array
                    const updatedTeachers = teachers.filter(t => t.id !== teacherId);
                    
                    // Save updated array to localStorage
                    localStorage.setItem('teachers', JSON.stringify(updatedTeachers));
                    
                    // Show success notification
                    showNotification(`Teacher ${teacher.name} has been permanently deleted from the system.`, 'success');
                    
                    // Firebase real-time listeners will automatically update the display
                    
                    console.log(`ðŸ—‘ï¸ Teacher deleted: ${teacher.name} (${teacherId})`);
                    
                } catch (error) {
                    console.error('Error deleting teacher:', error);
                    showNotification('Error deleting teacher. Please try again.', 'error');
                }
            }
        }

        // Setup Firebase real-time listeners for live updates
        async function setupFirebaseListeners() {
            try {
                if (typeof FirebaseDB !== 'undefined') {
                    const firebaseDB = new FirebaseDB();
                    await firebaseDB.initialize();
                    
                    // Listen for paysheet data changes
                    firebaseDB.getPaysheetData((paysheetData) => {
                        console.log('ðŸ“Š Paysheet data updated via Firebase listener');
                        
                        // Get current teachers data and update metrics
                        firebaseDB.getTeachers((teachers) => {
                            updateDashboardMetrics(teachers, paysheetData || {});
                        });
                    });
                    
                    // Listen for teachers data changes
                    const teachersRef = firebase.database().ref('teachers');
                    
                    // Listen for changes in teachers data
                    teachersRef.on('value', (snapshot) => {
                        const teachersData = snapshot.val();
                        console.log('ðŸ”„ Firebase teachers data updated:', teachersData ? Object.keys(teachersData).length : 0, 'teachers');
                        
                        let teachers = [];
                        
                        if (teachersData) {
                            teachers = Object.keys(teachersData).map(key => ({
                                id: key,
                                ...teachersData[key]
                            }));
                            console.log('ðŸ“Š Firebase teachers loaded:', teachers.length);
                        } else {
                            console.log('âš ï¸ No teachers found in Firebase');
                        }
                        
                        // Always merge localStorage teachers
                        const storedTeachers = JSON.parse(localStorage.getItem('teachers')) || [];
                        console.log('ðŸ“Š localStorage teachers:', storedTeachers.length);
                        
                        storedTeachers.forEach(localTeacher => {
                            const existsInFirebase = teachers.some(fbTeacher => fbTeacher.id === localTeacher.id);
                            if (!existsInFirebase) {
                                console.log('âž• Adding localStorage teacher:', localTeacher.name, localTeacher.status);
                                teachers.push(localTeacher);
                            }
                        });
                        
                        console.log('ðŸ“Š Total merged teachers:', teachers.length);
                        
                        // Log all teachers for debugging
                        teachers.forEach(teacher => {
                            console.log(`ðŸ‘¤ TEACHER: ${teacher.name} (${teacher.id}) - Status: ${teacher.status}`);
                        });
                        
                        const pendingTeachers = teachers.filter(t => t.status === 'Pending Approval');
                        console.log('â³ Pending teachers found:', pendingTeachers.length);
                        
                        updateTeacherTable(teachers);
                        updateDashboardMetrics(teachers, {}); // We'll load paysheet data separately
                        updatePendingApprovals(teachers);
                    });
                    
                    console.log('âœ… Firebase real-time listeners set up successfully');
                } else {
                    console.warn('âš ï¸ FirebaseDB not available, using periodic refresh fallback');
                    // Fallback to periodic refresh if Firebase not available
                    setInterval(function() {
                        loadTeachers();
                    }, 30000);
                }
            } catch (error) {
                console.error('âŒ Error setting up Firebase listeners:', error);
                // Fallback to periodic refresh
                setInterval(function() {
                    loadTeachers();
                }, 30000);
            }
        }

        // Paysheet Import Modal Variables
        let paysheetImporter = null;

        // Initialize paysheet importer
        document.addEventListener('DOMContentLoaded', function() {
            paysheetImporter = new PaysheetImporter();
            if (window.DataInjector && window.DataInjector.getGoogleSheetsDB()) {
                paysheetImporter.initialize(window.DataInjector.getGoogleSheetsDB());
            }
        });

        // Open paysheet import modal
        function openPaysheetImport() {
            const modal = document.getElementById('paysheet-import-modal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        // Close paysheet import modal
        function closePaysheetImport() {
            const modal = document.getElementById('paysheet-import-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                // Reset form
                document.getElementById('paysheet-file').value = '';
                document.getElementById('import-month').value = '';
                document.getElementById('import-year').value = new Date().getFullYear();
                document.getElementById('import-progress').classList.add('hidden');
                document.getElementById('import-result').classList.add('hidden');
            }
        }

        // Download sample CSV
        function downloadSampleCSV() {
            if (paysheetImporter) {
                paysheetImporter.downloadSampleCSV();
                showNotification('Sample CSV file downloaded successfully!', 'success');
            }
        }

        // Handle file import
        async function importPaysheetFile() {
            const fileInput = document.getElementById('paysheet-file');
            const monthSelect = document.getElementById('import-month');
            const yearSelect = document.getElementById('import-year');
            const progressDiv = document.getElementById('import-progress');
            const resultDiv = document.getElementById('import-result');

            // Validation
            if (!fileInput.files[0]) {
                showNotification('Please select a file to import', 'error');
                return;
            }

            if (!monthSelect.value) {
                showNotification('Please select a month', 'error');
                return;
            }

            if (!yearSelect.value) {
                showNotification('Please select a year', 'error');
                return;
            }

            const file = fileInput.files[0];
            const month = monthSelect.value;
            const year = yearSelect.value;

            // Show progress
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            try {
                const result = await paysheetImporter.importPaysheetFile(file, month, year);
                
                // Hide progress
                progressDiv.classList.add('hidden');
                
                // Show result
                resultDiv.classList.remove('hidden');
                const resultMessage = document.getElementById('import-result-message');
                
                if (result.success) {
                    resultMessage.className = 'text-success-600 font-medium';
                    resultMessage.textContent = result.message;
                    showNotification(`Paysheet imported successfully for ${month} ${year}!`, 'success');
                    
                    if (result.sheetName) {
                        const sheetLink = document.getElementById('sheet-link');
                        sheetLink.classList.remove('hidden');
                        sheetLink.querySelector('span').textContent = result.sheetName;
                    }
                } else {
                    resultMessage.className = 'text-error-600 font-medium';
                    resultMessage.textContent = result.message;
                    showNotification('Import failed: ' + result.message, 'error');
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                resultDiv.classList.remove('hidden');
                const resultMessage = document.getElementById('import-result-message');
                resultMessage.className = 'text-error-600 font-medium';
                resultMessage.textContent = 'Import failed: ' + error.message;
                showNotification('Import failed: ' + error.message, 'error');
            }
        }

        // View imported sheet (if Google Sheets)
        function viewImportedSheet() {
            const spreadsheetId = window.GOOGLE_SHEETS_CONFIG?.SPREADSHEET_ID;
            if (spreadsheetId) {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                window.open(url, '_blank');
            }
        }
    </script>

    <!-- Paysheet Import Modal -->
    <div id="import-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200 sticky top-0 bg-white">
                <h3 class="text-lg font-semibold text-gray-800">Import Paysheet Data</h3>
                <button id="close-modal" onclick="closePaysheetImport()" class="text-gray-500 hover:text-gray-700 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-800 mb-2">Import Instructions:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>â€¢ Upload CSV file with paysheet data</li>
                        <li>â€¢ File should contain: Teacher ID, Name, Salary details, Deductions</li>
                        <li>â€¢ Data will be imported to Google Sheets and create monthly view</li>
                        <li>â€¢ Download sample format if you need reference</li>
                    </ul>
                </div>

                <!-- Month and Year Selection -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="import-month" class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                        <select id="import-month" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Select Month</option>
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="import-year" class="block text-sm font-medium text-gray-700 mb-2">Year</label>
                        <select id="import-year" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="space-y-3">
                    <label for="paysheet-file" class="block text-sm font-medium text-gray-700">Select Paysheet File</label>
                    <div class="relative">
                        <input type="file" id="paysheet-file" accept=".csv,.xlsx,.xls" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary-600 border border-gray-300 rounded-md cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <p class="text-xs text-gray-500">Supported formats: CSV, Excel (.xlsx, .xls)</p>
                </div>

                <!-- Sample Download -->
                <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                    <div>
                        <h4 class="font-medium text-gray-800">Need sample format?</h4>
                        <p class="text-sm text-gray-600">Download sample CSV file to see the required format</p>
                    </div>
                    <button onclick="downloadSampleCSV()" class="px-4 py-2 bg-secondary text-white rounded-md hover:bg-secondary-600 transition-colors">
                        Download Sample
                    </button>
                </div>

                <!-- Progress -->
                <div id="import-progress" class="hidden">
                    <div class="flex items-center space-x-3">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                        <span class="text-sm text-gray-600">Importing paysheet data...</span>
                    </div>
                </div>

                <!-- Result -->
                <div id="import-result" class="hidden">
                    <div class="border rounded-lg p-4">
                        <p id="import-result-message" class="font-medium"></p>
                        <div id="sheet-link" class="hidden mt-2">
                            <button onclick="viewImportedSheet()" class="text-primary hover:text-primary-600 text-sm font-medium">
                                View in Google Sheets: <span></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end space-x-3 p-6 border-t border-gray-200 sticky bottom-0 bg-white">
                <button onclick="closePaysheetImport()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors border border-gray-300 rounded-md">
                    Cancel
                </button>
                <button onclick="importPaysheetFile()" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary-600 transition-colors shadow-sm">
                    Import Paysheet
                </button>
            </div>
        </div>
    </div>
</body>
</html>
<script>
        // Cleanup listeners on page unload
        window.addEventListener('beforeunload', function() {
            if (pendingApprovalsListener) {
                firebase.database().ref('teachers').off('value', pendingApprovalsListener);
            }
            if (teacherRecordsListener) {
                firebase.database().ref('teachers').off('value', teacherRecordsListener);
            }
        });

        // Initialize Firebase
        async function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded');
                }
                
                if (firebase.apps.length === 0) {
                    // Initialize Firebase with config
                    if (typeof firebaseConfig === 'undefined') {
                        throw new Error('Firebase config not found');
                    }
                    firebase.initializeApp(firebaseConfig);
                }
                
                console.log('âœ… Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('âŒ Firebase initialization failed:', error);
                throw error;
            }
        }

        // Test function to manually check button
        window.testImportButton = function() {
            console.log('ðŸ§ª MANUAL BUTTON TEST');
            const btn = document.getElementById('import-paysheet-btn');
            const modal = document.getElementById('import-modal');
            
            console.log('Button exists:', !!btn);
            console.log('Modal exists:', !!modal);
            
            if (btn) {
                console.log('Button onclick:', btn.onclick);
                console.log('Button classes:', btn.className);
                console.log('Button style:', btn.style.cssText);
                console.log('Button disabled:', btn.disabled);
                console.log('Button offsetParent:', btn.offsetParent);
                
                // Check if button is actually clickable
                const rect = btn.getBoundingClientRect();
                console.log('Button position:', rect);
                
                btn.click(); // Programmatically click
            }
            
            if (modal) {
                console.log('Modal classes:', modal.className);
                console.log('Modal style:', modal.style.cssText);
                console.log('Modal display:', window.getComputedStyle(modal).display);
                console.log('Modal z-index:', window.getComputedStyle(modal).zIndex);
            }
        };

        // Force open modal function
        window.forceOpenModal = function() {
            console.log('ðŸ”§ FORCE OPENING MODAL');
            const modal = document.getElementById('import-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.zIndex = '9999';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                console.log('âœ… Modal force opened');
            } else {
                console.error('âŒ Modal not found');
            }
        };

        // Load payslip requests with real-time updates
        async function loadPayslipRequests() {
            try {
                const requestsRef = firebase.database().ref('payslipRequests');
                
                requestsRef.on('value', (snapshot) => {
                    const requests = snapshot.val();
                    const requestsContainer = document.getElementById('payslip-requests');
                    
                    console.log('ðŸ” Payslip requests data:', requests);
                    
                    if (!requests) {
                        requestsContainer.innerHTML = '<p class="text-sm text-text-secondary">No payslip requests</p>';
                        return;
                    }
                    
                    const pendingRequests = Object.entries(requests).map(([key, request]) => ({
                        ...request,
                        id: key
                    })).filter(request => request.status === 'Pending');
                    
                    console.log('ðŸ” Pending requests:', pendingRequests);
                    
                    if (pendingRequests.length === 0) {
                        requestsContainer.innerHTML = '<p class="text-sm text-text-secondary">No pending requests</p>';
                        return;
                    }
                    
                    requestsContainer.innerHTML = pendingRequests.map(request => `
                        <div class="flex items-center justify-between p-4 bg-warning-50 border border-warning-200 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium text-text-primary">${request.teacherName}</h4>
                                <p class="text-sm text-text-secondary">ID: ${request.teacherId}</p>
                                <p class="text-xs text-text-secondary">${request.month} â€¢ ${request.purpose}</p>
                                <p class="text-xs text-warning-600">Requested: ${new Date(request.requestDate).toLocaleDateString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approvePayslipRequest('${request.id}')" 
                                    style="background-color: #16a34a; color: white; padding: 4px 12px; font-size: 14px; border-radius: 4px; border: none; cursor: pointer; transition: all 0.2s;"
                                    onmouseover="this.style.backgroundColor='#15803d'"
                                    onmouseout="this.style.backgroundColor='#16a34a'">
                                    Approve
                                </button>
                                <button onclick="rejectPayslipRequest('${request.id}')" 
                                    style="background-color: #dc2626; color: white; padding: 4px 12px; font-size: 14px; border-radius: 4px; border: none; cursor: pointer; transition: all 0.2s; margin-left: 8px;"
                                    onmouseover="this.style.backgroundColor='#b91c1c'"
                                    onmouseout="this.style.backgroundColor='#dc2626'">
                                    Reject
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    console.log(`âœ… Updated payslip requests: ${pendingRequests.length} pending`);
                });
                
            } catch (error) {
                console.error('Error loading payslip requests:', error);
                document.getElementById('payslip-requests').innerHTML = 
                    '<p class="text-sm text-error-600">Error loading requests</p>';
            }
        }

        // Approve payslip request - GLOBAL FUNCTION
        window.approvePayslipRequest = async function(requestId) {
            try {
                console.log('ðŸ” Approving request:', requestId);
                const requestRef = firebase.database().ref(`payslipRequests/${requestId}`);
                await requestRef.update({
                    status: 'Approved',
                    approvedBy: sessionStorage.getItem('adminId') || 'admin',
                    approvalDate: new Date().toISOString()
                });
                
                console.log(`âœ… Payslip request ${requestId} approved`);
                alert('Payslip request approved! Teacher can now view their payslip.');
                
            } catch (error) {
                console.error('Error approving payslip request:', error);
                alert('Error approving request. Please try again.');
            }
        };

        // Reject payslip request - GLOBAL FUNCTION
        window.rejectPayslipRequest = async function(requestId) {
            if (!confirm('Are you sure you want to reject this payslip request?')) {
                return;
            }
            
            try {
                console.log('ðŸ” Rejecting request:', requestId);
                const requestRef = firebase.database().ref(`payslipRequests/${requestId}`);
                await requestRef.update({
                    status: 'Rejected',
                    rejectedBy: sessionStorage.getItem('adminId') || 'admin',
                    rejectionDate: new Date().toISOString()
                });
                
                console.log(`âŒ Payslip request ${requestId} rejected`);
                alert('Payslip request rejected.');
                
            } catch (error) {
                console.error('Error rejecting payslip request:', error);
                alert('Error rejecting request. Please try again.');
            }
        };

        // Initialize Firebase first, then check authentication
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Firebase App if not already initialized
                if (!firebase.apps.length) {
                    firebase.initializeApp(window.FIREBASE_CONFIG || window.firebaseConfig);
                    console.log('ðŸ”¥ Firebase App initialized');
                } else {
                    console.log('ðŸ”¥ Firebase App already initialized');
                }
                
                // Now check authentication
                firebase.auth().onAuthStateChanged(async function(user) {
                    if (user) {
                        console.log('âœ… User authenticated:', user.uid, user.email);
                        
                        // Check if this is an admin user
                        const isAdmin = await checkAdminAccess(user);
                        
                        if (isAdmin) {
                            console.log('âœ… Admin access granted');
                            initializeDashboard();
                        } else {
                            console.log('âŒ Access denied - Not an admin user');
                            // Silently redirect without showing error message
                            await firebase.auth().signOut();
                            window.location.href = 'admin_login.html';
                        }
                    } else {
                        console.log('âŒ User not authenticated, redirecting to login...');
                        window.location.href = 'admin_login.html';
                    }
                });
            } catch (error) {
                console.error('âŒ Firebase initialization failed:', error);
                window.location.href = 'admin_login.html';
            }
        });

        // Check if user has admin access
        async function checkAdminAccess(user) {
            try {
                // Method 1: Check if user email is in admin list
                const adminEmails = [
                    'admin@bvit.edu',
                    'admin@teacherpay.com',
                    'administrator@bvit.edu'
                ];
                
                if (adminEmails.includes(user.email.toLowerCase())) {
                    console.log('âœ… Admin access granted via email whitelist');
                    return true;
                }
                
                // Method 2: Check Firebase database for admin role
                try {
                    const adminRef = firebase.database().ref('admins').child(user.uid);
                    const snapshot = await adminRef.once('value');
                    const adminData = snapshot.val();
                    
                    if (adminData && adminData.role === 'admin') {
                        console.log('âœ… Admin access granted via database role');
                        return true;
                    }
                } catch (dbError) {
                    console.warn('âš ï¸ Could not check admin database:', dbError);
                }
                
                // Method 3: Check if user is in teachers database with admin role
                try {
                    const teachersRef = firebase.database().ref('teachers');
                    const teachersSnapshot = await teachersRef.once('value');
                    const teachersData = teachersSnapshot.val();
                    
                    if (teachersData) {
                        for (const teacherId in teachersData) {
                            const teacher = teachersData[teacherId];
                            if (teacher.uid === user.uid && teacher.role === 'admin') {
                                console.log('âœ… Admin access granted via teacher admin role');
                                return true;
                            }
                        }
                    }
                } catch (teacherError) {
                    console.warn('âš ï¸ Could not check teachers database:', teacherError);
                }
                
                console.log('âŒ No admin access found for user:', user.email);
                return false;
                
            } catch (error) {
                console.error('âŒ Error checking admin access:', error);
                return false;
            }
        }

        // Initialize dashboard when user is authenticated
        async function initializeDashboard() {
            console.log('ðŸš€ Admin Dashboard initializing...');
            
            try {
                // Firebase is already initialized by firebase-config.js
                console.log('ðŸ”¥ Firebase already initialized, proceeding with dashboard setup...');
                
                // Wait a bit for DOM to fully render
                setTimeout(() => {
                    setupImportPaysheetEvents();
                    
                    // Add manual test function to window
                    console.log('ðŸ”§ Debug: Run testImportButton() in console to test button');
                }, 100);
                
                // Load all dashboard data (only once - listeners will handle updates)
                await loadPayslipRequests();
                await loadPendingTeacherApprovals();
                await loadTeacherRecords();
                await loadTeachers(); // Add this to load teachers in main table
                
                console.log('âœ… Admin Dashboard initialized successfully');
                console.log('ðŸ”§ Debug Commands:');
                console.log('  - testImportButton() - Test button functionality');
                console.log('  - forceOpenModal() - Force open modal');
            } catch (error) {
                console.error('âŒ Dashboard initialization failed:', error);
            }
        }

        // Global listener references for cleanup
        let pendingApprovalsListener = null;
        let teacherRecordsListener = null;

        // Load pending teacher approvals with real-time updates
        async function loadPendingTeacherApprovals() {
            try {
                // Clean up existing listener
                if (pendingApprovalsListener) {
                    firebase.database().ref('teachers').off('value', pendingApprovalsListener);
                }
                
                const teachersRef = firebase.database().ref('teachers');
                
                // Create new listener and store reference
                pendingApprovalsListener = (snapshot) => {
                    const teachers = snapshot.val();
                    const pendingContainer = document.getElementById('pending-teacher-approvals');
                    
                    if (!teachers) {
                        pendingContainer.innerHTML = '<p class="text-sm text-text-secondary">No pending approvals</p>';
                        return;
                    }
                    
                    const pendingTeachers = Object.values(teachers).filter(teacher => 
                        teacher.status === 'Pending Approval'
                    );
                    
                    if (pendingTeachers.length === 0) {
                        pendingContainer.innerHTML = '<p class="text-sm text-text-secondary">No pending approvals</p>';
                        return;
                    }
                    
                    pendingContainer.innerHTML = pendingTeachers.map(teacher => `
                        <div class="flex items-center justify-between p-4 bg-warning-50 border border-warning-200 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium text-text-primary">${teacher.name}</h4>
                                <p class="text-sm text-text-secondary">${teacher.email}</p>
                                <p class="text-xs text-text-secondary">${teacher.department} â€¢ ${teacher.designation}</p>
                                <p class="text-xs text-warning-600">Registered: ${new Date(teacher.registrationDate).toLocaleDateString()}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="approveTeacher('${teacher.id}')" 
                                    class="px-3 py-1 bg-success-600 text-white text-sm rounded hover:bg-success-700 transition-colors">
                                    Approve
                                </button>
                                <button onclick="rejectTeacher('${teacher.id}')" 
                                    class="px-3 py-1 bg-error-600 text-white text-sm rounded hover:bg-error-700 transition-colors">
                                    Reject
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    console.log(`âœ… Updated pending approvals: ${pendingTeachers.length} teachers waiting`);
                };
                
                // Attach listener
                teachersRef.on('value', pendingApprovalsListener);
                
            } catch (error) {
                console.error('Error loading pending approvals:', error);
                document.getElementById('pending-teacher-approvals').innerHTML = 
                    '<p class="text-sm text-error-600">Error loading pending approvals</p>';
            }
        }

        // Load teacher records for main table with real-time updates
        async function loadTeacherRecords() {
            try {
                // Clean up existing listener
                if (teacherRecordsListener) {
                    firebase.database().ref('teachers').off('value', teacherRecordsListener);
                }
                
                const teachersRef = firebase.database().ref('teachers');
                
                // Create new listener and store reference
                teacherRecordsListener = (snapshot) => {
                    const teachers = snapshot.val();
                    const tableBody = document.getElementById('teacher-table-body');
                    
                    if (!teachers) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-text-secondary">No teachers found</td></tr>';
                        return;
                    }
                    
                    const teacherList = Object.values(teachers);
                    
                    tableBody.innerHTML = teacherList.map(teacher => `
                        <tr>
                            <td><input type="checkbox" class="rounded border-secondary-300 text-primary focus:ring-primary-500" /></td>
                            <td class="font-medium">${teacher.id}</td>
                            <td>${teacher.name}</td>
                            <td>${teacher.department}</td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${
                                    teacher.status === 'Active' ? 'bg-success-100 text-success-800' :
                                    teacher.status === 'Pending Approval' ? 'bg-warning-100 text-warning-800' :
                                    teacher.status === 'Rejected' ? 'bg-error-100 text-error-800' :
                                    'bg-gray-100 text-gray-800'
                                }">
                                    ${teacher.status || 'Unknown'}
                                </span>
                            </td>
                            <td class="text-text-secondary">
                                ${teacher.approvalDate ? new Date(teacher.approvalDate).toLocaleDateString() : '-'}
                            </td>
                            <td>
                                <div class="flex space-x-2">
                                    <button onclick="viewTeacher('${teacher.id}')" class="text-primary hover:text-primary-600 text-sm">View</button>
                                    ${teacher.status === 'Pending Approval' ? 
                                        `<button onclick="approveTeacher('${teacher.id}')" class="text-success-600 hover:text-success-800 text-sm">Approve</button>
                                         <button onclick="rejectTeacher('${teacher.id}')" class="text-error-600 hover:text-error-800 text-sm">Reject</button>` :
                                        `<button onclick="editTeacher('${teacher.id}')" class="text-secondary-600 hover:text-secondary-800 text-sm">Edit</button>`
                                    }
                                </div>
                            </td>
                        </tr>
                    `).join('');
                    
                    console.log(`âœ… Loaded ${teacherList.length} teachers with real-time updates`);
                };
                
                // Attach listener
                teachersRef.on('value', teacherRecordsListener);
                
            } catch (error) {
                console.error('Error loading teacher records:', error);
                document.getElementById('teacher-table-body').innerHTML = 
                    '<tr><td colspan="7" class="text-center py-4 text-error-600">Error loading teacher records</td></tr>';
            }
        }

        // Approve teacher
        async function approveTeacher(teacherId) {
            try {
                const teacherRef = firebase.database().ref(`teachers/${teacherId}`);
                await teacherRef.update({
                    status: 'Active',
                    approvedBy: sessionStorage.getItem('adminId') || 'admin',
                    approvalDate: new Date().toISOString()
                });
                
                console.log(`âœ… Teacher ${teacherId} approved successfully`);
                
                // Show success message
                alert(`Teacher ${teacherId} has been approved and can now login.`);
                
                // Real-time listeners will automatically update both widgets
                
            } catch (error) {
                console.error('Error approving teacher:', error);
                alert('Error approving teacher. Please try again.');
            }
        }

        // Reject teacher
        async function rejectTeacher(teacherId) {
            if (!confirm('Are you sure you want to reject this teacher registration?')) {
                return;
            }
            
            try {
                const teacherRef = firebase.database().ref(`teachers/${teacherId}`);
                await teacherRef.update({
                    status: 'Rejected',
                    rejectedBy: sessionStorage.getItem('adminId') || 'admin',
                    rejectionDate: new Date().toISOString()
                });
                
                console.log(`âŒ Teacher ${teacherId} rejected`);
                
                // Show message
                alert(`Teacher ${teacherId} registration has been rejected.`);
                
                // Real-time listeners will automatically update both widgets
                
            } catch (error) {
                console.error('Error rejecting teacher:', error);
                alert('Error rejecting teacher. Please try again.');
            }
        }

        // Import Paysheet Modal Functions
        function setupImportPaysheetEvents() {
            console.log('Setting up import paysheet events...');
            
            const importBtn = document.getElementById('import-paysheet-btn');
            const closeBtn = document.getElementById('close-modal');
            const modal = document.getElementById('import-modal');
            
            console.log('Import button found:', !!importBtn);
            console.log('Close button found:', !!closeBtn);
            console.log('Modal found:', !!modal);
            
            if (importBtn && modal) {
                // Remove any existing event listeners first
                importBtn.removeEventListener('click', openImportModal);
                
                // Add new event listener
                importBtn.addEventListener('click', openImportModal);
                console.log('âœ… Import button event listener attached');
            } else {
                console.error('âŒ Import button or modal not found');
                console.log('Button element:', importBtn);
                console.log('Modal element:', modal);
            }

            if (closeBtn && modal) {
                closeBtn.addEventListener('click', function() {
                    modal.classList.add('hidden');
                });
                console.log('âœ… Close button event listener attached');
            }
        }

        // Debug function to test button
        function debugButton() {
            console.log('ðŸ” DEBUGGING IMPORT BUTTON...');
            console.log('Button element:', document.getElementById('import-paysheet-btn'));
            console.log('Modal element:', document.getElementById('import-modal'));
            console.log('All elements with import-paysheet-btn:', document.querySelectorAll('#import-paysheet-btn'));
            console.log('All elements with import-modal:', document.querySelectorAll('#import-modal'));
            
            // Test direct modal opening
            const modal = document.getElementById('import-modal');
            if (modal) {
                console.log('Modal classes before:', modal.className);
                modal.classList.remove('hidden');
                console.log('Modal classes after:', modal.className);
                console.log('Modal display style:', window.getComputedStyle(modal).display);
            }
        }

        // Separate function for opening modal (moved to global scope)
        function openImportModal() {
            console.log('ðŸš€ IMPORT BUTTON CLICKED! Opening modal...');
            showImportModal();
        }

        // Close paysheet import modal
        function closePaysheetImport() {
            console.log('ðŸ”’ Closing import paysheet modal...');
            const modal = document.getElementById('import-modal');
            if (modal) {
                modal.classList.add('hidden');
                console.log('âœ… Modal closed successfully');
            }
        }

        // Import paysheet file
        async function importPaysheetFile() {
            const month = document.getElementById('import-month').value;
            const year = document.getElementById('import-year').value;
            const fileInput = document.getElementById('paysheet-file');
            const file = fileInput.files[0];

            if (!month || !year || !file) {
                alert('Please select month, year, and file before importing.');
                return;
            }

            // Show progress
            document.getElementById('import-progress').classList.remove('hidden');
            document.getElementById('import-result').classList.add('hidden');

            try {
                // Initialize paysheet importer
                const importer = new PaysheetImporter();
                const result = await importer.importPaysheetFile(file, month, year);

                // Hide progress
                document.getElementById('import-progress').classList.add('hidden');

                if (result.success) {
                    // Show success result
                    document.getElementById('import-result').classList.remove('hidden');
                    document.getElementById('import-result-message').textContent = result.message;
                    document.getElementById('import-result-message').className = 'font-medium text-success-600';
                    
                    console.log('âœ… Paysheet imported successfully:', result);
                    
                    // Reset form
                    setTimeout(() => {
                        document.getElementById('import-modal').classList.add('hidden');
                        fileInput.value = '';
                        document.getElementById('import-month').value = '';
                        document.getElementById('import-year').value = '';
                        document.getElementById('import-result').classList.add('hidden');
                    }, 3000);
                } else {
                    // Show error result
                    document.getElementById('import-result').classList.remove('hidden');
                    document.getElementById('import-result-message').textContent = result.message;
                    document.getElementById('import-result-message').className = 'font-medium text-error-600';
                }
            } catch (error) {
                console.error('Import error:', error);
                
                // Hide progress and show error
                document.getElementById('import-progress').classList.add('hidden');
                document.getElementById('import-result').classList.remove('hidden');
                document.getElementById('import-result-message').textContent = 'Error importing paysheet: ' + error.message;
                document.getElementById('import-result-message').className = 'font-medium text-error-600';
            }
        }

        // Download sample CSV
        function downloadSampleCSV() {
            const importer = new PaysheetImporter();
            importer.downloadSampleCSV();
        }

        // Close paysheet import modal
        function closePaysheetImport() {
            document.getElementById('import-modal').classList.add('hidden');
        }

        // View teacher details
        function viewTeacher(teacherId) {
            // Implement teacher detail view
            console.log('View teacher:', teacherId);
        }

        // Edit teacher
        function editTeacher(teacherId) {
            // Implement teacher edit functionality
            console.log('Edit teacher:', teacherId);
        }

        // Add Teacher Modal Functions
        function showAddTeacherModal() {
            document.getElementById('add-teacher-modal').classList.remove('hidden');
        }

        function closeAddTeacherModal() {
            document.getElementById('add-teacher-modal').classList.add('hidden');
            document.getElementById('add-teacher-form').reset();
        }

        async function addNewTeacher() {
            const form = document.getElementById('add-teacher-form');
            const formData = new FormData(form);
            
            const teacherData = {
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                designation: formData.get('designation'),
                department: formData.get('department'),
                password: formData.get('password')
            };

            // Validate required fields
            if (!teacherData.name || !teacherData.email || !teacherData.phone || 
                !teacherData.designation || !teacherData.department || !teacherData.password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(teacherData.email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }

            // Validate password length
            if (teacherData.password.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                return;
            }

            try {
                // Show loading state
                const addButton = document.querySelector('#add-teacher-modal button[onclick="addNewTeacher()"]');
                const originalText = addButton.textContent;
                addButton.textContent = 'Creating Account...';
                addButton.disabled = true;

                // Create Firebase Authentication account
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(teacherData.email, teacherData.password);
                const user = userCredential.user;

                // Update user profile
                await user.updateProfile({
                    displayName: teacherData.name
                });

                // Send email verification
                await user.sendEmailVerification();

                // Sign out the newly created user to maintain admin session
                await firebase.auth().signOut();

                // Generate teacher ID
                const teacherId = generateTeacherId(teacherData.department);

                // Create teacher record with Firebase UID
                const newTeacher = {
                    id: teacherId,
                    uid: user.uid, // Store Firebase UID for authentication linking
                    name: teacherData.name,
                    email: teacherData.email,
                    phone: teacherData.phone,
                    designation: teacherData.designation,
                    department: teacherData.department,
                    status: 'Active', // Admin-created teachers are automatically active
                    registrationDate: new Date().toISOString(),
                    createdBy: 'Admin',
                    authCreated: true // Flag to indicate Firebase Auth account was created
                };

                // Save to Firebase
                await firebase.database().ref('teachers').child(teacherId).set(newTeacher);

                // Also save to localStorage for backward compatibility
                const teachers = JSON.parse(localStorage.getItem('teachers')) || [];
                teachers.push(newTeacher);
                localStorage.setItem('teachers', JSON.stringify(teachers));

                // Show success message
                showNotification(`Teacher account created successfully! Verification email sent to ${teacherData.email}`, 'success');
                
                // Close modal and reset form
                closeAddTeacherModal();
                
                // Refresh teacher list
                loadTeachers();

            } catch (error) {
                console.error('Error creating teacher account:', error);
                
                let errorMessage = 'Failed to create teacher account. ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage += 'Email address is already registered.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage += 'Password is too weak.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage += 'Invalid email address.';
                } else {
                    errorMessage += error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                // Reset button
                const addButton = document.querySelector('#add-teacher-modal button[onclick="addNewTeacher()"]');
                addButton.textContent = originalText;
                addButton.disabled = false;
            }
        }

        // Generate teacher ID based on department
        function generateTeacherId(department) {
            const prefix = department.substring(0, 3).toUpperCase();
            const timestamp = Date.now().toString().slice(-6);
            return `${prefix}${timestamp}`;
        }


        // Add new teacher with Firebase Authentication
        async function addNewTeacher() {
            const form = document.getElementById('add-teacher-form');
            const formData = new FormData(form);
            
            const email = formData.get('email');
            const password = formData.get('password');
            const name = formData.get('name');
            
            console.log('ðŸ” Starting teacher creation process...');
            console.log('ðŸ“§ Email:', email);
            console.log('ðŸ‘¤ Name:', name);
            
            try {
                // Show loading state
                const submitBtn = document.querySelector('#add-teacher-modal button[onclick="addNewTeacher()"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating Account...';
                submitBtn.disabled = true;

                console.log('ðŸ”¥ Creating Firebase Auth account...');
                
                // Store current admin user
                const currentAdmin = firebase.auth().currentUser;
                console.log('ðŸ‘¨â€ðŸ’¼ Current admin:', currentAdmin?.email);

                // Create Firebase Authentication account
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('âœ… Firebase Auth account created:', user.uid);

                // Update user profile with display name
                await user.updateProfile({
                    displayName: name
                });
                
                console.log('âœ… User profile updated');

                // Prepare teacher data for database
                const teacherData = {
                    id: `T${Date.now()}`,
                    uid: user.uid,
                    name: name,
                    email: email,
                    phone: formData.get('phone'),
                    designation: formData.get('designation'),
                    department: formData.get('department'),
                    status: 'Active',
                    registrationDate: new Date().toISOString(),
                    approvedBy: sessionStorage.getItem('adminId'),
                    approvalDate: new Date().toISOString(),
                    authCreated: true
                };

                console.log('ðŸ’¾ Saving teacher data to Firebase Database...');
                
                // Add teacher to Firebase Database directly
                const teachersRef = firebase.database().ref('teachers');
                await teachersRef.child(teacherData.id).set(teacherData);
                
                console.log('âœ… Teacher data saved to database');
                
                // Send email verification
                console.log('ðŸ“§ Sending email verification...');
                await user.sendEmailVerification();
                console.log('âœ… Email verification sent');
                
                // Sign out the newly created user to restore admin session
                await firebase.auth().signOut();
                console.log('ðŸ”„ Teacher signed out');
                
                // Re-authenticate admin
                if (currentAdmin) {
                    console.log('ðŸ”„ Restoring admin session...');
                    // Admin session should automatically restore
                }
                
                // Close modal and refresh teachers list
                closeAddTeacherModal();
                loadTeachers();
                
                // Show success message
                console.log('ðŸŽ‰ Teacher account creation completed successfully!');
                alert(`Teacher account created successfully!\nEmail: ${email}\nUID: ${user.uid}\nVerification email sent to teacher.`);
                
            } catch (error) {
                console.error('Error creating teacher account:', error);
                let errorMessage = 'Failed to create teacher account. ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'Email is already registered.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password should be at least 6 characters.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                alert(errorMessage);
            } finally {
                // Reset button state
                const submitBtn = document.querySelector('#add-teacher-modal button[onclick="addNewTeacher()"]');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
    </script>
    
    <script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>